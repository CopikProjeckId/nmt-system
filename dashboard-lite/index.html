<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NMT Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace'],
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] { display: none !important; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="dashboard()" x-init="init()">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-lg font-bold text-gray-900 tracking-tight">NMT Dashboard</h1>
        <span class="text-xs font-medium text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full">v1.0</span>
      </div>
      <div class="flex items-center gap-3">
        <span x-show="connected" x-cloak class="flex items-center gap-1.5 text-xs font-medium text-emerald-700 bg-emerald-50 border border-emerald-200 px-2.5 py-1 rounded-full">
          <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
          Connected
        </span>
        <span x-show="!connected" class="flex items-center gap-1.5 text-xs font-medium text-red-700 bg-red-50 border border-red-200 px-2.5 py-1 rounded-full">
          <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
          Offline
        </span>
      </div>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="bg-white border-b border-gray-200 overflow-x-auto">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex gap-0 -mb-px">
        <template x-for="tab in tabs" :key="tab.id">
          <button
            @click="switchTab(tab.id)"
            :class="activeTab === tab.id
              ? 'border-indigo-600 text-indigo-600 font-semibold'
              : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium'"
            class="px-3 py-3 text-sm border-b-2 transition-colors whitespace-nowrap"
            x-text="tab.label"
          ></button>
        </template>
      </div>
    </div>
  </nav>

  <!-- Main Content Area -->
  <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- TAB: OVERVIEW -->
    <section x-show="activeTab === 'overview'" x-cloak>
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-base font-semibold text-gray-900">System Overview</h2>
        <span class="text-xs text-gray-400" x-text="lastRefresh ? 'Updated ' + lastRefresh : ''"></span>
      </div>
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <p class="text-2xl font-bold text-gray-900" x-text="formatNumber(stats.neurons ?? '--')"></p>
          <p class="text-xs font-medium text-gray-500 mt-1 uppercase tracking-wide">Neurons</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <p class="text-2xl font-bold text-gray-900" x-text="formatNumber(stats.synapses ?? '--')"></p>
          <p class="text-xs font-medium text-gray-500 mt-1 uppercase tracking-wide">Synapses</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <p class="text-2xl font-bold text-gray-900" x-text="formatNumber(stats.chunks?.total ?? '--')"></p>
          <p class="text-xs font-medium text-gray-500 mt-1 uppercase tracking-wide">Chunks</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <p class="text-2xl font-bold text-gray-900" x-text="formatBytes(stats.chunks?.totalSize)"></p>
          <p class="text-xs font-medium text-gray-500 mt-1 uppercase tracking-wide">Total Size</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <p class="text-2xl font-bold text-gray-900" x-text="formatNumber(stats.hnsw?.totalNodes ?? '--')"></p>
          <p class="text-xs font-medium text-gray-500 mt-1 uppercase tracking-wide">HNSW Vectors</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <p class="text-2xl font-bold text-gray-900" x-text="stats.hnsw?.maxLayer ?? '--'"></p>
          <p class="text-xs font-medium text-gray-500 mt-1 uppercase tracking-wide">HNSW Layers</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <p class="text-2xl font-bold text-gray-900" x-text="stats.storage?.backend ?? '--'"></p>
          <p class="text-xs font-medium text-gray-500 mt-1 uppercase tracking-wide">Storage</p>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <p class="text-2xl font-bold text-gray-900" x-text="formatBytes(stats.chunks?.avgSize)"></p>
          <p class="text-xs font-medium text-gray-500 mt-1 uppercase tracking-wide">Avg Chunk</p>
        </div>
      </div>
      <div class="bg-white border border-gray-200 rounded-lg p-5">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Data Directory</h3>
        <p class="text-sm font-mono text-gray-900 break-all" x-text="stats.storage?.dataDir ?? '--'"></p>
      </div>
    </section>

    <!-- TAB: NEURONS -->
    <section x-show="activeTab === 'neurons'" x-cloak>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-base font-semibold text-gray-900">Neurons <span class="text-sm font-normal text-gray-500" x-text="'(' + neuronTotal + ')'"></span></h2>
        <button @click="loadNeurons()" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium px-2 py-1 rounded hover:bg-indigo-50">Refresh</button>
      </div>
      <div class="flex gap-4">
        <div class="flex-1 min-w-0">
          <div x-show="neuronsLoading" class="bg-white border rounded-lg p-12 text-center">
            <div class="inline-block w-5 h-5 border-2 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
          </div>
          <div x-show="!neuronsLoading && neurons.length > 0" class="bg-white border rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b bg-gray-50">
                  <th class="text-left text-xs font-semibold text-gray-600 px-4 py-2.5">ID</th>
                  <th class="text-left text-xs font-semibold text-gray-600 px-4 py-2.5">Type</th>
                  <th class="text-left text-xs font-semibold text-gray-600 px-4 py-2.5">Tags</th>
                  <th class="text-right text-xs font-semibold text-gray-600 px-4 py-2.5">Chunks</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="neuron in neurons" :key="neuron.id">
                  <tr @click="selectNeuron(neuron)" :class="selectedNeuron?.id === neuron.id ? 'bg-indigo-50' : 'hover:bg-gray-50'" class="border-b cursor-pointer">
                    <td class="px-4 py-2.5 font-mono text-xs text-indigo-700" x-text="neuron.id.substring(0, 8) + '...'"></td>
                    <td class="px-4 py-2.5 text-gray-700" x-text="neuron.sourceType || '--'"></td>
                    <td class="px-4 py-2.5">
                      <template x-for="tag in (neuron.tags || []).slice(0,3)" :key="tag">
                        <span class="inline-block bg-indigo-50 text-indigo-700 text-xs px-1.5 py-0.5 rounded mr-1" x-text="tag"></span>
                      </template>
                    </td>
                    <td class="px-4 py-2.5 text-right font-mono text-xs" x-text="neuron.chunks ?? '--'"></td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
              <span class="text-xs text-gray-500" x-text="paginationLabel()"></span>
              <div class="flex gap-2">
                <button @click="prevPage()" :disabled="neuronPage === 0" class="px-3 py-1.5 text-xs bg-white border rounded disabled:opacity-40">Prev</button>
                <button @click="nextPage()" :disabled="(neuronPage + 1) * neuronLimit >= neuronTotal" class="px-3 py-1.5 text-xs bg-white border rounded disabled:opacity-40">Next</button>
              </div>
            </div>
          </div>
        </div>
        <div x-show="selectedNeuron" x-cloak class="w-80 flex-shrink-0">
          <div class="bg-white border rounded-lg overflow-hidden sticky top-4">
            <div class="flex items-center justify-between px-4 py-3 border-b bg-gray-50">
              <h3 class="text-sm font-semibold">Detail</h3>
              <button @click="selectedNeuron = null" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-4 space-y-3 max-h-96 overflow-y-auto text-xs">
              <div><label class="text-gray-500">ID</label><p class="font-mono break-all" x-text="selectedNeuron?.id"></p></div>
              <div><label class="text-gray-500">Merkle Root</label><p class="font-mono break-all" x-text="selectedNeuron?.merkleRoot || '--'"></p></div>
              <div><label class="text-gray-500">Content</label><pre class="bg-gray-50 border rounded p-2 max-h-40 overflow-y-auto whitespace-pre-wrap" x-text="selectedContent || 'Loading...'"></pre></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: GRAPH -->
    <section x-show="activeTab === 'graph'" x-cloak>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-base font-semibold text-gray-900">Knowledge Graph</h2>
        <button @click="loadGraph()" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium px-2 py-1 rounded hover:bg-indigo-50">Refresh</button>
      </div>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div class="bg-white border rounded-lg p-4">
          <p class="text-2xl font-bold text-indigo-600" x-text="graphData.stats?.nodeCount ?? 0"></p>
          <p class="text-xs text-gray-500">Nodes</p>
        </div>
        <div class="bg-white border rounded-lg p-4">
          <p class="text-2xl font-bold text-emerald-600" x-text="graphData.stats?.edgeCount ?? 0"></p>
          <p class="text-xs text-gray-500">Edges</p>
        </div>
        <div class="bg-white border rounded-lg p-4">
          <p class="text-2xl font-bold text-amber-600" x-text="graphData.nodes?.length > 0 ? (graphData.edges?.length / graphData.nodes?.length).toFixed(2) : 0"></p>
          <p class="text-xs text-gray-500">Avg Connections</p>
        </div>
      </div>
      <div class="bg-white border rounded-lg p-4">
        <h3 class="text-sm font-semibold mb-3">Graph Edges</h3>
        <div class="max-h-80 overflow-y-auto">
          <table class="w-full text-xs">
            <thead class="sticky top-0 bg-white">
              <tr class="border-b"><th class="text-left px-2 py-1">Source</th><th class="text-left px-2 py-1">Target</th><th class="text-left px-2 py-1">Type</th><th class="text-right px-2 py-1">Weight</th></tr>
            </thead>
            <tbody>
              <template x-for="(edge, i) in (graphData.edges || []).slice(0, 100)" :key="i">
                <tr class="border-b border-gray-50">
                  <td class="px-2 py-1 font-mono" x-text="edge.source?.substring(0, 8) + '...'"></td>
                  <td class="px-2 py-1 font-mono" x-text="edge.target?.substring(0, 8) + '...'"></td>
                  <td class="px-2 py-1" x-text="edge.type"></td>
                  <td class="px-2 py-1 text-right" x-text="edge.weight?.toFixed(3)"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TAB: INFERENCE -->
    <section x-show="activeTab === 'inference'" x-cloak>
      <h2 class="text-base font-semibold text-gray-900 mb-4">Inference Engine</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="bg-white border rounded-lg p-5">
          <h3 class="text-sm font-semibold mb-3">Run Inference</h3>
          <div class="space-y-3">
            <div>
              <label class="text-xs text-gray-600 block mb-1">Neuron ID</label>
              <input type="text" x-model="inferNeuronId" placeholder="Enter neuron ID..." class="w-full px-3 py-2 text-sm border rounded focus:ring-2 focus:ring-indigo-500 outline-none font-mono">
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-600 block mb-1">Type</label>
                <select x-model="inferType" class="w-full px-3 py-2 text-sm border rounded">
                  <option value="forward">Forward</option>
                  <option value="backward">Backward</option>
                  <option value="causal">Causal</option>
                  <option value="bidirectional">Bidirectional</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-gray-600 block mb-1">Depth</label>
                <input type="number" x-model.number="inferDepth" min="1" max="10" class="w-full px-3 py-2 text-sm border rounded">
              </div>
            </div>
            <button @click="runInference()" :disabled="inferring || !inferNeuronId" class="w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded hover:bg-indigo-700 disabled:opacity-50 flex items-center justify-center gap-2">
              <span x-show="inferring" class="w-3.5 h-3.5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
              Run Inference
            </button>
          </div>
        </div>
        <div class="bg-white border rounded-lg p-5">
          <h3 class="text-sm font-semibold mb-3">Results</h3>
          <div x-show="inferResults" class="space-y-2">
            <div class="flex gap-4 text-xs">
              <span class="text-gray-500">Type: <span class="font-semibold text-gray-900" x-text="inferResults?.type"></span></span>
              <span class="text-gray-500">Found: <span class="font-semibold text-gray-900" x-text="inferResults?.totalFound"></span></span>
            </div>
            <div class="max-h-60 overflow-y-auto">
              <template x-for="(r, i) in (inferResults?.results || []).slice(0, 20)" :key="i">
                <div class="flex items-center justify-between py-1 border-b border-gray-100 text-xs">
                  <span class="font-mono text-indigo-700" x-text="r.id?.substring(0, 12) + '...'"></span>
                  <span class="text-gray-500">depth: <span x-text="r.distance"></span></span>
                </div>
              </template>
            </div>
          </div>
          <p x-show="!inferResults" class="text-sm text-gray-400 text-center py-8">Run inference to see results</p>
        </div>
      </div>
    </section>

    <!-- TAB: ATTRACTORS -->
    <section x-show="activeTab === 'attractors'" x-cloak>
      <h2 class="text-base font-semibold text-gray-900 mb-4">Attractor Model</h2>
      <div class="bg-white border rounded-lg p-5">
        <div class="text-center py-8">
          <p class="text-gray-500 mb-2">Attractors are managed via CLI</p>
          <div class="bg-gray-100 rounded p-3 font-mono text-xs text-left inline-block">
            <p class="text-gray-600"># Create attractor</p>
            <p class="text-indigo-700">nmt attractor create "Goal Name" --strength 0.8</p>
            <p class="text-gray-600 mt-2"># List attractors</p>
            <p class="text-indigo-700">nmt attractor list</p>
            <p class="text-gray-600 mt-2"># Find path to goal</p>
            <p class="text-indigo-700">nmt attractor path &lt;neuron-id&gt; &lt;attractor-id&gt;</p>
            <p class="text-gray-600 mt-2"># Calculate influence</p>
            <p class="text-indigo-700">nmt attractor influence &lt;neuron-id&gt;</p>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: LEARNING -->
    <section x-show="activeTab === 'learning'" x-cloak>
      <h2 class="text-base font-semibold text-gray-900 mb-4">Four-Stage Learning</h2>
      <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
            <span class="text-blue-600 font-bold">1</span>
          </div>
          <p class="text-sm font-semibold">Extract</p>
          <p class="text-xs text-gray-500">Identify info</p>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
            <span class="text-green-600 font-bold">2</span>
          </div>
          <p class="text-sm font-semibold">Pattern</p>
          <p class="text-xs text-gray-500">Recognize patterns</p>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-2">
            <span class="text-amber-600 font-bold">3</span>
          </div>
          <p class="text-sm font-semibold">Process</p>
          <p class="text-xs text-gray-500">Learn reasoning</p>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
            <span class="text-purple-600 font-bold">4</span>
          </div>
          <p class="text-sm font-semibold">Outcome</p>
          <p class="text-xs text-gray-500">Apply feedback</p>
        </div>
      </div>
      <div class="bg-white border rounded-lg p-5">
        <h3 class="text-sm font-semibold mb-3">CLI Commands</h3>
        <div class="bg-gray-100 rounded p-3 font-mono text-xs">
          <p class="text-gray-600"># Start learning session</p>
          <p class="text-indigo-700">nmt learn session start</p>
          <p class="text-gray-600 mt-2"># Extract from neuron</p>
          <p class="text-indigo-700">nmt learn extract &lt;neuron-id&gt; --limit 20</p>
          <p class="text-gray-600 mt-2"># Full learning pipeline</p>
          <p class="text-indigo-700">nmt orchestrate learn --input "Q" --output "A" --success</p>
        </div>
      </div>
    </section>

    <!-- TAB: SYNC -->
    <section x-show="activeTab === 'sync'" x-cloak>
      <h2 class="text-base font-semibold text-gray-900 mb-4">State Synchronization</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <button @click="loadSyncStatus()" class="mb-3 text-xs text-indigo-600 hover:text-indigo-800 font-medium px-2 py-1 rounded hover:bg-indigo-50">Refresh Status</button>
          <div class="bg-white border rounded-lg p-5">
            <h3 class="text-sm font-semibold mb-3">Current State</h3>
            <div class="space-y-2 text-xs">
              <div class="flex justify-between"><span class="text-gray-500">Node ID</span><span class="font-mono" x-text="syncStatus?.nodeId ?? '--'"></span></div>
              <div class="flex justify-between"><span class="text-gray-500">Sequence</span><span class="font-mono" x-text="syncStatus?.sequence ?? 0"></span></div>
              <div class="flex justify-between"><span class="text-gray-500">Neurons</span><span class="font-mono" x-text="syncStatus?.neuronCount ?? 0"></span></div>
              <div class="flex justify-between"><span class="text-gray-500">Peers</span><span class="font-mono" x-text="syncStatus?.peers?.length ?? 0"></span></div>
            </div>
          </div>
        </div>
        <div class="bg-white border rounded-lg p-5">
          <h3 class="text-sm font-semibold mb-3">CLI Commands</h3>
          <div class="bg-gray-100 rounded p-3 font-mono text-xs">
            <p class="text-gray-600"># Check sync status</p>
            <p class="text-indigo-700">nmt sync status</p>
            <p class="text-gray-600 mt-2"># View change log</p>
            <p class="text-indigo-700">nmt sync changes --from 0</p>
            <p class="text-gray-600 mt-2"># Export state</p>
            <p class="text-indigo-700">nmt sync export --output backup.json</p>
            <p class="text-gray-600 mt-2"># Import state</p>
            <p class="text-indigo-700">nmt sync import backup.json</p>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: SEARCH -->
    <section x-show="activeTab === 'search'" x-cloak>
      <h2 class="text-base font-semibold text-gray-900 mb-4">Semantic Search</h2>
      <div class="bg-white border rounded-lg p-5 mb-5">
        <div class="flex gap-3">
          <input type="text" x-model="searchQuery" @keydown.enter="doSearch()" placeholder="Enter search query..." class="flex-1 px-3 py-2 text-sm border rounded focus:ring-2 focus:ring-indigo-500 outline-none">
          <input type="number" x-model.number="searchK" min="1" max="100" class="w-20 px-3 py-2 text-sm border rounded" placeholder="K">
          <label class="flex items-center gap-2 text-xs"><input type="checkbox" x-model="searchIncludeContent" class="rounded"> Content</label>
          <button @click="doSearch()" :disabled="searching || !searchQuery" class="px-5 py-2 text-sm font-medium text-white bg-indigo-600 rounded hover:bg-indigo-700 disabled:opacity-50">Search</button>
        </div>
      </div>
      <div x-show="searchResults.length > 0" class="space-y-3">
        <template x-for="(r, i) in searchResults" :key="i">
          <div class="bg-white border rounded-lg p-4">
            <div class="flex items-center gap-3 mb-2">
              <span class="font-mono text-xs text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded" x-text="r.neuronId?.substring(0, 12) + '...'"></span>
              <span class="text-xs font-semibold px-2 py-0.5 rounded" :class="r.score > 0.8 ? 'text-emerald-700 bg-emerald-50' : 'text-amber-700 bg-amber-50'" x-text="'Score: ' + r.score?.toFixed(4)"></span>
            </div>
            <pre x-show="r.content" class="bg-gray-50 border rounded p-3 text-xs font-mono whitespace-pre-wrap max-h-32 overflow-y-auto" x-text="r.content"></pre>
          </div>
        </template>
      </div>
    </section>

    <!-- TAB: INGEST -->
    <section x-show="activeTab === 'ingest'" x-cloak>
      <h2 class="text-base font-semibold text-gray-900 mb-4">Ingest Content</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div class="bg-white border rounded-lg p-5">
          <div class="space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-600 block mb-1">Text Content</label>
              <textarea x-model="ingestText" rows="8" placeholder="Enter text to ingest..." class="w-full px-3 py-2 text-sm border rounded font-mono resize-y"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-medium text-gray-600 block mb-1">Source Type</label>
                <input type="text" x-model="ingestSourceType" placeholder="dashboard" class="w-full px-3 py-2 text-sm border rounded">
              </div>
              <div>
                <label class="text-xs font-medium text-gray-600 block mb-1">Tags</label>
                <input type="text" x-model="ingestTags" placeholder="tag1, tag2" class="w-full px-3 py-2 text-sm border rounded">
              </div>
            </div>
            <button @click="doIngest()" :disabled="ingesting || !ingestText" class="w-full px-4 py-2.5 text-sm font-medium text-white bg-emerald-600 rounded hover:bg-emerald-700 disabled:opacity-50">
              <span x-text="ingesting ? 'Ingesting...' : 'Ingest'"></span>
            </button>
          </div>
        </div>
        <div>
          <div x-show="ingestResult" class="bg-emerald-50 border border-emerald-200 rounded-lg p-5">
            <h3 class="text-sm font-semibold text-emerald-800 mb-2">Success</h3>
            <p class="text-xs font-mono break-all" x-text="'ID: ' + ingestResult?.neuronId"></p>
            <p class="text-xs mt-1" x-text="'Chunks: ' + ingestResult?.chunks"></p>
          </div>
          <div x-show="ingestError" class="bg-red-50 border border-red-200 rounded-lg p-5">
            <p class="text-sm text-red-700" x-text="ingestError"></p>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: VERIFY -->
    <section x-show="activeTab === 'verify'" x-cloak>
      <h2 class="text-base font-semibold text-gray-900 mb-4">Data Integrity</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div class="space-y-4">
          <div class="bg-white border rounded-lg p-5">
            <h3 class="text-sm font-semibold mb-3">Verify All Neurons</h3>
            <button @click="doVerifyAll()" :disabled="verifying" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded hover:bg-indigo-700 disabled:opacity-50">
              <span x-text="verifying ? 'Verifying...' : 'Run Verification'"></span>
            </button>
          </div>
          <div x-show="verifyAllResult" class="bg-white border rounded-lg p-5">
            <div class="flex gap-4 text-xs mb-3">
              <span>Total: <span class="font-bold" x-text="verifyAllResult?.total"></span></span>
              <span class="text-emerald-600">Valid: <span class="font-bold" x-text="verifyAllResult?.valid"></span></span>
              <span class="text-red-600">Invalid: <span class="font-bold" x-text="verifyAllResult?.invalid"></span></span>
            </div>
          </div>
        </div>
        <div class="space-y-4">
          <div class="bg-white border rounded-lg p-5">
            <h3 class="text-sm font-semibold mb-3">Verify Single</h3>
            <div class="flex gap-2">
              <input type="text" x-model="verifyNeuronId" placeholder="Neuron ID..." class="flex-1 px-3 py-2 text-sm border rounded font-mono">
              <button @click="doVerifySingle()" :disabled="verifySingleLoading" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded hover:bg-indigo-700 disabled:opacity-50">Verify</button>
            </div>
          </div>
          <div x-show="verifySingleResult" :class="verifySingleResult?.valid ? 'bg-emerald-50 border-emerald-200' : 'bg-red-50 border-red-200'" class="border rounded-lg p-5">
            <span class="text-xs font-bold px-2 py-0.5 rounded" :class="verifySingleResult?.valid ? 'text-emerald-800 bg-emerald-200' : 'text-red-800 bg-red-200'" x-text="verifySingleResult?.valid ? 'VALID' : 'INVALID'"></span>
          </div>
        </div>
      </div>
    </section>

  </main>

  <script>
    function dashboard() {
      return {
        activeTab: 'overview',
        tabs: [
          { id: 'overview', label: 'Overview' },
          { id: 'neurons', label: 'Neurons' },
          { id: 'graph', label: 'Graph' },
          { id: 'inference', label: 'Inference' },
          { id: 'attractors', label: 'Attractors' },
          { id: 'learning', label: 'Learning' },
          { id: 'sync', label: 'Sync' },
          { id: 'search', label: 'Search' },
          { id: 'ingest', label: 'Ingest' },
          { id: 'verify', label: 'Verify' },
        ],
        connected: false, lastRefresh: '', stats: {},
        neurons: [], neuronTotal: 0, neuronPage: 0, neuronLimit: 50, neuronsLoading: false,
        selectedNeuron: null, selectedContent: '',
        graphData: { nodes: [], edges: [], stats: {} },
        inferNeuronId: '', inferType: 'forward', inferDepth: 3, inferring: false, inferResults: null,
        syncStatus: null,
        searchQuery: '', searchK: 10, searchIncludeContent: true, searchResults: [], searching: false,
        ingestText: '', ingestSourceType: 'dashboard', ingestTags: '', ingesting: false, ingestResult: null, ingestError: null,
        verifying: false, verifyAllResult: null, verifyNeuronId: '', verifySingleResult: null, verifySingleLoading: false,

        async init() {
          await this.checkHealth();
          await this.loadStats();
          setInterval(() => { if (this.activeTab === 'overview') this.loadStats(); }, 30000);
        },

        switchTab(id) {
          this.activeTab = id;
          if (id === 'overview') this.loadStats();
          else if (id === 'neurons') this.loadNeurons();
          else if (id === 'graph') this.loadGraph();
          else if (id === 'sync') this.loadSyncStatus();
        },

        async api(method, path, body) {
          const opts = { method, headers: { 'Content-Type': 'application/json' } };
          if (body) opts.body = JSON.stringify(body);
          try {
            const res = await fetch('/api/v1' + path, opts);
            if (!res.ok) throw new Error((await res.json().catch(() => ({}))).error || `HTTP ${res.status}`);
            this.connected = true;
            return await res.json();
          } catch (err) {
            if (err.message.includes('fetch')) this.connected = false;
            throw err;
          }
        },

        async checkHealth() { try { await this.api('GET', '/health'); this.connected = true; } catch { this.connected = false; } },
        async loadStats() { try { this.stats = await this.api('GET', '/stats'); this.lastRefresh = new Date().toLocaleTimeString(); } catch {} },

        async loadNeurons() {
          this.neuronsLoading = true;
          try {
            const d = await this.api('GET', `/neurons?limit=${this.neuronLimit}&offset=${this.neuronPage * this.neuronLimit}`);
            this.neurons = d.neurons || []; this.neuronTotal = d.total || 0;
          } catch { this.neurons = []; }
          this.neuronsLoading = false;
        },

        async selectNeuron(n) {
          this.selectedNeuron = n; this.selectedContent = 'Loading...';
          try { const d = await this.api('GET', `/neurons/${n.id}/content`); this.selectedContent = d.content || ''; } catch { this.selectedContent = ''; }
        },

        prevPage() { if (this.neuronPage > 0) { this.neuronPage--; this.loadNeurons(); } },
        nextPage() { if ((this.neuronPage + 1) * this.neuronLimit < this.neuronTotal) { this.neuronPage++; this.loadNeurons(); } },
        paginationLabel() { return `${this.neuronPage * this.neuronLimit + 1}-${Math.min((this.neuronPage + 1) * this.neuronLimit, this.neuronTotal)} of ${this.neuronTotal}`; },

        async loadGraph() { try { this.graphData = await this.api('GET', '/graph'); } catch { this.graphData = { nodes: [], edges: [], stats: {} }; } },

        async runInference() {
          if (!this.inferNeuronId) return;
          this.inferring = true; this.inferResults = null;
          try { this.inferResults = await this.api('POST', `/inference/${this.inferType}`, { neuronId: this.inferNeuronId, depth: this.inferDepth }); } catch (e) { alert(e.message); }
          this.inferring = false;
        },

        async loadSyncStatus() { try { this.syncStatus = await this.api('GET', '/sync/status'); } catch {} },

        async doSearch() {
          if (!this.searchQuery) return;
          this.searching = true; this.searchResults = [];
          try { const d = await this.api('POST', '/search', { query: this.searchQuery, k: this.searchK, includeContent: this.searchIncludeContent }); this.searchResults = d.results || []; } catch {}
          this.searching = false;
        },

        async doIngest() {
          if (!this.ingestText) return;
          this.ingesting = true; this.ingestResult = null; this.ingestError = null;
          try {
            const tags = this.ingestTags.split(',').map(t => t.trim()).filter(t => t);
            this.ingestResult = await this.api('POST', '/ingest', { text: this.ingestText, sourceType: this.ingestSourceType, tags });
            this.ingestText = ''; this.ingestTags = '';
          } catch (e) { this.ingestError = e.message; }
          this.ingesting = false;
        },

        async doVerifyAll() { this.verifying = true; try { this.verifyAllResult = await this.api('GET', '/verify'); } catch {} this.verifying = false; },
        async doVerifySingle() {
          if (!this.verifyNeuronId) return;
          this.verifySingleLoading = true; this.verifySingleResult = null;
          try { this.verifySingleResult = await this.api('GET', `/verify/${this.verifyNeuronId}`); } catch {}
          this.verifySingleLoading = false;
        },

        formatNumber(v) { return v == null || v === '--' ? '--' : Number(v).toLocaleString(); },
        formatBytes(b) { if (b == null) return '--'; if (b === 0) return '0 B'; const u = ['B','KB','MB','GB']; const i = Math.floor(Math.log(b)/Math.log(1024)); return (b/Math.pow(1024,i)).toFixed(1) + ' ' + u[i]; },
      };
    }
  </script>
</body>
</html>
